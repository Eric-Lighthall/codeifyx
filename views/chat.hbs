<div class="row h-100">
  <div class="col-md-2 fixed-sidebar" id="recent-chats">
    <div class="recent-chats d-flex flex-column justify-content-between h-100">
      <div class="text-center mt-3 logo-container">
        <a href="/">
          <img src="/images/codeifyxlogosmall.webp" alt="Small Logo" class="small-logo img-fluid">
          <img src="/images/codeifyxlogo3.webp" alt="Full Logo" class="full-logo img-fluid">
        </a>
      </div>
      <div class="chat-list text-center mt-4">
        <h4 class="recent-chats-title">
          <span class="recent-chats-text">Recent Chats</span>
        </h4>
        <ul class="list-group">
          {{#each recentChats}}
          <li class="list-group-item">
            <a href="/chat/{{this.id}}">{{this.title}}</a>
          </li>
          {{/each}}
        </ul>
      </div>
      <div class="sidebar-footer">
        <div class="settings text-center mb-4">
          <a href="/settings" class="settings-link">
            <i class="fas fa-cog"></i>
            <span class="settings-text">Settings</span>
          </a>
        </div>
        <div class="terms text-center mb-4">
          <a href="/terms" class="terms-link">
            <i class="fas fa-file-alt"></i>
            <span class="terms-text">Terms</span>
          </a>
        </div>
        <div class="profile text-center mb-4">
          <a href="/profile" class="profile-link">
            <img src="{{user.image}}" alt="Profile Image" class="profile-image rounded-circle">
            <span class="display-name fw-bold">{{user.displayName}}</span>
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-10 d-flex justify-content-center mx-auto">
    <div class="main-content w-70 d-flex flex-column h-100">
      <div class="row">
        <div class="col-md-12">
          <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="languageDropdown"
              data-bs-toggle="dropdown" aria-expanded="false">
              <img src="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/icons/python/python-original.svg"
                class="language-logo me-2" />
              Python
              <i class="fas fa-caret-down ms-2"></i>
            </button>
            <ul class="dropdown-menu" aria-labelledby="languageDropdown">
              <li>
                <a class="dropdown-item" href="#">
                  <img src="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/icons/python/python-original.svg"
                    class="language-logo me-2" />
                  Python
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="#">
                  <img
                    src="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/icons/javascript/javascript-original.svg"
                    class="language-logo me-2" />
                  JavaScript
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="#">
                  <img src="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/icons/java/java-original.svg"
                    class="language-logo me-2" />
                  Java
                </a>
              </li>
              <!-- Add more language options as needed -->
            </ul>
          </div>
        </div>
      </div>
      <div class="row w-100 flex-grow-1">
        <div class="col-md-12 mt-5">
          <div class="chat-messages h-100">
            <div class="empty-state text-center">
              <img src="/images/codeifyxlogosmall.webp" alt="CodeifyX Logo" class="mb-3 small-logo fade-in">
              <h3 class="fw-bold fade-in">What can I help you with?</h3>
            </div>
            {{#each messages}}
            <div class="message {{role}}">
              <p>{{content}}</p>
            </div>
            {{/each}}
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="chat-bar">
            <div class="input-group">
              <input type="text" class="form-control" id="messageInput" placeholder="Type your message..."
                aria-label="Message">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const chatMessages = document.querySelector('.chat-messages');
  const messageInput = document.getElementById('messageInput');
  const emptyState = document.querySelector('.empty-state');

  messageInput.addEventListener('keypress', async (event) => {
    if (event.key === 'Enter') {
      const userMessage = messageInput.value;
      messageInput.value = '';
      addMessageToChat('user', userMessage);

      emptyState.style.display = 'none';

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: userMessage }),
        });

        if (response.ok) {
          const stream = response.body.pipeThrough(new TextDecoderStream()).getReader();
          const assistantMessageElement = addMessageToChat('assistant', '');
          const assistantMessageContentElement = assistantMessageElement.querySelector('.message-content p');

          while (true) {
            const { done, value } = await stream.read();
            if (done) break;

            assistantMessageContentElement.innerHTML += value;
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        } else {
          throw new Error('API request failed');
        }
      } catch (error) {
        console.error('Error:', error);
        addMessageToChat('error', 'Oops! Something went wrong. Please try again.');
      }
    }
  });

  function addMessageToChat(role, content) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');

    if (role === 'user') {
      messageElement.classList.add('user-message');
      messageElement.innerHTML = `
      <div class="message-container">
        <img src="{{user.image}}" alt="User Image" class="user-image rounded-circle">
        <div class="message-content">
          <p>${content}</p>
        </div>
      </div>
    `;
    } else if (role === 'assistant') {
      messageElement.classList.add('assistant-message');
      messageElement.innerHTML = `
      <div class="message-container">
        <img src="/images/codeifyxlogosmall.webp" alt="AI Image" class="assistant-image rounded-circle">
        <div class="message-content">
          <p>${content}</p>
        </div>
      </div>
    `;
    } else {
      messageElement.innerHTML = `<p>${content}</p>`;
    }

    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    emptyState.style.display = 'none';
    return messageElement;
  }
</script>